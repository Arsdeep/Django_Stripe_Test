{% load static %}

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Payment - Checkout</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="{% static 'css/checkout.css' %}" />
  </head>
  <body>
    <div class="container">
      <div class="payment-container">
        <div class="payment-card">
          <div class="payment-header">
            <div class="payment-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                  d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"
                />
              </svg>
            </div>
            <h2>Secure Payment</h2>
            <p class="payment-subtitle">Complete your purchase securely</p>
          </div>

          <div class="card-element-container">
            <label class="card-label">
              üí≥ Card Details
              <span
                class="test-card-info"
                title="Test Card: 4242 4242 4242 4242"
                >‚ÑπÔ∏è</span
              >
            </label>
            <div id="card-element"></div>
            <small class="form-text"
              >Use card: 4242 4242 4242 4242 | Any future expiration date and
              CVV</small
            >
          </div>

          <button id="payBtn" class="pay-button">
            <span class="button-text">Complete Payment</span>
          </button>

          <div id="card-errors" class="error-message" role="alert"></div>
        </div>
      </div>
    </div>

    <div id="success-overlay" class="success-overlay">
      <div class="success-content">
        <div class="success-checkmark">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
          </svg>
        </div>
        <h3 style="color: #1e293b; font-weight: 700; margin-bottom: 0.5rem">
          Payment Successful!
        </h3>
        <p style="color: #64748b">Redirecting you to the shop...</p>
      </div>
    </div>

    <script>
      const stripe = Stripe("{{ stripe_public_key }}");
      const elements = stripe.elements();
      const clientSecret = "{{ client_secret }}";
      const paymentIntentId = "{{ payment_intent_id }}";

      // Create a card element with custom styling
      const card = elements.create("card", {
        hidePostalCode: true,
        style: {
          base: {
            fontSize: "16px",
            color: "#ffffffff",
            fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            "::placeholder": {
              color: "#94a3b8",
            },
          },
          invalid: {
            color: "#ef4444",
            iconColor: "#ef4444",
          },
        },
      });
      card.mount("#card-element");

      const payBtn = document.getElementById("payBtn");
      const cardErrors = document.getElementById("card-errors");
      const successOverlay = document.getElementById("success-overlay");
      const buttonText = payBtn.querySelector(".button-text");

      // Handle real-time validation errors
      card.on("change", function (event) {
        if (event.error) {
          cardErrors.textContent = event.error.message;
          cardErrors.classList.add("show");
        } else {
          cardErrors.textContent = "";
          cardErrors.classList.remove("show");
        }
      });

      payBtn.addEventListener("click", function () {
        payBtn.disabled = true;
        payBtn.classList.add("processing");
        buttonText.innerHTML = '<span class="spinner"></span>Processing...';
        cardErrors.classList.remove("show");

        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
        }
        const csrftoken = getCookie("csrftoken");

        stripe
          .confirmCardPayment(clientSecret, {
            payment_method: {
              card: card,
            },
          })
          .then(function (result) {
            if (result.error) {
              cardErrors.textContent = result.error.message;
              cardErrors.classList.add("show");
              payBtn.disabled = false;
              payBtn.classList.remove("processing");
              buttonText.textContent = "Complete Payment";
            } else {
              if (result.paymentIntent.status === "succeeded") {
                // Mark order as paid in Django
                fetch("{% url 'confirm_order_payment' %}", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrftoken,
                  },
                  body: `payment_intent_id=${encodeURIComponent(
                    paymentIntentId
                  )}`,
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.status === "success") {
                      successOverlay.classList.add("show");
                      setTimeout(() => {
                        window.location.href = "{% url 'shop_home' %}";
                      }, 2000);
                    } else {
                      cardErrors.textContent =
                        "Something went wrong updating your order. Please contact support.";
                      cardErrors.classList.add("show");
                      payBtn.disabled = false;
                      payBtn.classList.remove("processing");
                      buttonText.textContent = "Complete Payment";
                    }
                  })
                  .catch(() => {
                    cardErrors.textContent = "Network error. Please try again.";
                    cardErrors.classList.add("show");
                    payBtn.disabled = false;
                    payBtn.classList.remove("processing");
                    buttonText.textContent = "Complete Payment";
                  });
              }
            }
          });
      });
    </script>
  </body>
</html>
