<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Payment - Checkout</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      :root {
        --primary-color: #6366f1;
        --primary-dark: #4f46e5;
        --secondary-color: #f59e0b;
        --success-color: #10b981;
        --error-color: #ef4444;
        --bg-light: #f8fafc;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        align-items: center;
        padding: 2rem 0;
      }

      .payment-container {
        max-width: 600px;
        margin: 0 auto;
      }

      .payment-card {
        background: white;
        border-radius: 24px;
        padding: 3rem;
        box-shadow: var(--card-shadow-hover);
        position: relative;
        overflow: hidden;
      }

      .payment-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--secondary-color)
        );
      }

      .payment-header {
        text-align: center;
        margin-bottom: 2.5rem;
      }

      .payment-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      .payment-icon svg {
        width: 40px;
        height: 40px;
        fill: white;
      }

      .payment-header h2 {
        color: #1e293b;
        font-weight: 700;
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .payment-subtitle {
        color: #64748b;
        font-size: 1.1rem;
      }

      .secure-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        color: var(--success-color);
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-top: 1rem;
        border: 2px solid #bbf7d0;
      }

      .card-element-container {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
      }

      .card-element-container:focus-within {
        border-color: var(--primary-color);
        background: white;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .card-label {
        color: #475569;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .test-card-info {
        cursor: help;
        font-size: 1rem;
      }

      .form-text {
        display: block;
        color: #64748b;
        margin-top: 0.75rem;
        font-size: 0.85rem;
        padding: 0.5rem;
        background: #f1f5f9;
        border-radius: 6px;
        border-left: 3px solid var(--primary-color);
      }

      #card-element {
        padding: 0.5rem 0;
      }

      .StripeElement {
        width: 100%;
      }

      .pay-button {
        width: 100%;
        background: linear-gradient(135deg, var(--secondary-color), #f97316);
        border: none;
        padding: 1.25rem;
        font-size: 1.2rem;
        font-weight: 700;
        border-radius: 12px;
        color: white;
        box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .pay-button:hover:not(:disabled) {
        box-shadow: 0 15px 30px rgba(245, 158, 11, 0.4);
        background: linear-gradient(135deg, #f97316, var(--secondary-color));
      }

      .pay-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .pay-button.processing {
        background: linear-gradient(135deg, #94a3b8, #64748b);
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
        margin-right: 0.5rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
        border: 2px solid #fecaca;
        color: var(--error-color);
        padding: 1rem;
        border-radius: 12px;
        margin-top: 1rem;
        font-weight: 600;
        display: none;
        animation: shake 0.5s ease-in-out;
      }

      .error-message.show {
        display: block;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .security-icon {
        width: 20px;
        height: 20px;
        fill: var(--success-color);
      }

      .success-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease-in-out;
      }

      .success-overlay.show {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .success-content {
        background: white;
        padding: 3rem;
        border-radius: 24px;
        text-align: center;
        max-width: 400px;
        animation: scaleIn 0.5s ease-out;
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .success-checkmark {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, var(--success-color), #059669);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        animation: bounceIn 0.6s ease-out;
      }

      @keyframes bounceIn {
        0% {
          transform: scale(0);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .success-checkmark svg {
        width: 50px;
        height: 50px;
        fill: white;
      }

      @media (max-width: 768px) {
        .payment-card {
          padding: 2rem 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="payment-container">
        <div class="payment-card">
          <div class="payment-header">
            <div class="payment-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                  d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"
                />
              </svg>
            </div>
            <h2>Secure Payment</h2>
            <p class="payment-subtitle">Complete your purchase securely</p>
          </div>

          <div class="card-element-container">
            <label class="card-label">
              üí≥ Card Details
              <span
                class="test-card-info"
                title="Test Card: 4242 4242 4242 4242"
                >‚ÑπÔ∏è</span
              >
            </label>
            <div id="card-element"></div>
            <small class="form-text"
              >Use card: 4242 4242 4242 4242 | Any future expiration date and
              CVV</small
            >
          </div>

          <button id="payBtn" class="pay-button">
            <span class="button-text">Complete Payment</span>
          </button>

          <div id="card-errors" class="error-message" role="alert"></div>
        </div>
      </div>
    </div>

    <div id="success-overlay" class="success-overlay">
      <div class="success-content">
        <div class="success-checkmark">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
          </svg>
        </div>
        <h3 style="color: #1e293b; font-weight: 700; margin-bottom: 0.5rem">
          Payment Successful!
        </h3>
        <p style="color: #64748b">Redirecting you to the shop...</p>
      </div>
    </div>

    <script>
      const stripe = Stripe("{{ stripe_public_key }}");
      const elements = stripe.elements();
      const clientSecret = "{{ client_secret }}";
      const paymentIntentId = "{{ payment_intent_id }}";

      // Create a card element with custom styling
      const card = elements.create("card", {
        hidePostalCode: true,
        style: {
          base: {
            fontSize: "16px",
            color: "#1e293b",
            fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            "::placeholder": {
              color: "#94a3b8",
            },
          },
          invalid: {
            color: "#ef4444",
            iconColor: "#ef4444",
          },
        },
      });
      card.mount("#card-element");

      const payBtn = document.getElementById("payBtn");
      const cardErrors = document.getElementById("card-errors");
      const successOverlay = document.getElementById("success-overlay");
      const buttonText = payBtn.querySelector(".button-text");

      // Handle real-time validation errors
      card.on("change", function (event) {
        if (event.error) {
          cardErrors.textContent = event.error.message;
          cardErrors.classList.add("show");
        } else {
          cardErrors.textContent = "";
          cardErrors.classList.remove("show");
        }
      });

      payBtn.addEventListener("click", function () {
        payBtn.disabled = true;
        payBtn.classList.add("processing");
        buttonText.innerHTML = '<span class="spinner"></span>Processing...';
        cardErrors.classList.remove("show");

        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
        }
        const csrftoken = getCookie("csrftoken");

        stripe
          .confirmCardPayment(clientSecret, {
            payment_method: {
              card: card,
            },
          })
          .then(function (result) {
            if (result.error) {
              cardErrors.textContent = result.error.message;
              cardErrors.classList.add("show");
              payBtn.disabled = false;
              payBtn.classList.remove("processing");
              buttonText.textContent = "Complete Payment";
            } else {
              if (result.paymentIntent.status === "succeeded") {
                // Mark order as paid in Django
                fetch("{% url 'confirm_order_payment' %}", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrftoken,
                  },
                  body: `payment_intent_id=${encodeURIComponent(
                    paymentIntentId
                  )}`,
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.status === "success") {
                      successOverlay.classList.add("show");
                      setTimeout(() => {
                        window.location.href = "{% url 'shop_home' %}";
                      }, 2000);
                    } else {
                      cardErrors.textContent =
                        "Something went wrong updating your order. Please contact support.";
                      cardErrors.classList.add("show");
                      payBtn.disabled = false;
                      payBtn.classList.remove("processing");
                      buttonText.textContent = "Complete Payment";
                    }
                  })
                  .catch(() => {
                    cardErrors.textContent = "Network error. Please try again.";
                    cardErrors.classList.add("show");
                    payBtn.disabled = false;
                    payBtn.classList.remove("processing");
                    buttonText.textContent = "Complete Payment";
                  });
              }
            }
          });
      });
    </script>
  </body>
</html>
